<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System.Text;
using DevTools.Core.Results;

namespace DevTools.Cli.Logging;

internal static class CliErrorLogger
{
    private static readonly object Sync = new();

    public static void LogErrors(string toolKey, IReadOnlyList&lt;ErrorDetail&gt; errors)
    {
        if (errors is null || errors.Count == 0)
            return;

        foreach (var error in errors)
            LogLine(toolKey, FormatError(error));
    }

    public static void LogException(string toolKey, Exception ex)
    {
        if (ex is null)
            return;

        var details = ex.ToString().Replace(&#39;\r&#39;, &#39; &#39;).Replace(&#39;\n&#39;, &#39; &#39;);
        LogLine(toolKey, $&quot;UNHANDLED | {details}&quot;);
    }

    private static string FormatError(ErrorDetail error)
    {
        var sb = new StringBuilder();
        sb.Append(&quot;ERROR&quot;);

        if (!string.IsNullOrWhiteSpace(error.Code))
            sb.Append(&quot; [&quot;).Append(error.Code).Append(&#39;]&#39;);

        if (!string.IsNullOrWhiteSpace(error.Message))
            sb.Append(&#39; &#39;).Append(error.Message.Trim());

        if (!string.IsNullOrWhiteSpace(error.Details))
            sb.Append(&quot; | &quot;).Append(error.Details.Trim());

        if (error.Exception is not null)
            sb.Append(&quot; | &quot;).Append(error.Exception.GetType().Name).Append(&quot;: &quot;).Append(error.Exception.Message);

        return sb.ToString().Replace(&#39;\r&#39;, &#39; &#39;).Replace(&#39;\n&#39;, &#39; &#39;);
    }

    private static void LogLine(string toolKey, string message)
    {
        var key = Sanitize(toolKey);
        if (string.IsNullOrWhiteSpace(key))
            key = &quot;unknown&quot;;

        var appData = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var logDir = Path.Combine(appData, &quot;DevTools&quot;, &quot;logs&quot;);
        Directory.CreateDirectory(logDir);

        var filePath = Path.Combine(logDir, $&quot;{key}-{DateTime.Now:yyyyMMdd}.log&quot;);
        var line = $&quot;{DateTime.Now:yyyy-MM-dd HH:mm:ss} | {message}&quot;;

        lock (Sync)
        {
            File.AppendAllText(filePath, line + Environment.NewLine);
        }
    }

    private static string Sanitize(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return string.Empty;

        var sb = new StringBuilder(value.Length);
        foreach (var c in value)
        {
            if (char.IsLetterOrDigit(c) || c is &#39;-&#39; or &#39;_&#39;)
                sb.Append(char.ToLowerInvariant(c));
        }

        return sb.ToString();
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>