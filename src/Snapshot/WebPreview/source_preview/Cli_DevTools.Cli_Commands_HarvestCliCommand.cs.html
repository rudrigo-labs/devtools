<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Cli.Ui;
using DevTools.Cli.Logging;
using DevTools.Harvest.Engine;
using DevTools.Harvest.Models;
using DevTools.Cli.App;

namespace DevTools.Cli.Commands;

public sealed class HarvestCliCommand : ICliCommand
{
    private readonly CliConsole _ui;
    private readonly CliInput _input;
    private readonly HarvestEngine _engine;

    public HarvestCliCommand(CliConsole ui, CliInput input)
    {
        _ui = ui;
        _input = input;
        _engine = new HarvestEngine();
    }

    public string Key =&gt; &quot;harvest&quot;;
    public string Name =&gt; &quot;Harvest&quot;;
    public string Description =&gt; &quot;Identifica classes C# reutilizaveis (helpers/extensions).&quot;;

    public async Task&lt;int&gt; ExecuteAsync(CliLaunchOptions options, CancellationToken ct)
    {
        // 1. Resolve Parameters (Args -&gt; Interactive -&gt; Default/Error)
        var root = options.GetOption(&quot;root&quot;) ?? options.GetOption(&quot;source&quot;);
        var outputPath = options.GetOption(&quot;output&quot;) ?? options.GetOption(&quot;out&quot;);
        var configPath = options.GetOption(&quot;config&quot;);
        
        var minScoreStr = options.GetOption(&quot;min-score&quot;) ?? options.GetOption(&quot;min&quot;);
        int? minScore = int.TryParse(minScoreStr, out var s) ? s : null;

        var copyFilesStr = options.GetOption(&quot;copy-files&quot;) ?? options.GetOption(&quot;copy&quot;);
        bool? copyFiles = copyFilesStr != null ? (copyFilesStr == &quot;true&quot;) : null;

        // Interactive Fallback
        if (!options.IsNonInteractive)
        {
            if (string.IsNullOrWhiteSpace(root))
            {
                root = _input.ReadRequired(&quot;Pasta raiz (Source)&quot;, &quot;ex: C:\\Projetos\\MeuApp&quot;);
                options.Options[&quot;root&quot;] = root;
            }

            if (string.IsNullOrWhiteSpace(outputPath))
            {
                outputPath = _input.ReadRequired(&quot;Pasta de destino (Output)&quot;, &quot;ex: C:\\Backup\\Harvest&quot;);
                options.Options[&quot;output&quot;] = outputPath;
            }

            if (string.IsNullOrWhiteSpace(configPath))
            {
                configPath = _input.ReadOptional(&quot;Config (opcional)&quot;, &quot;enter para usar padrao&quot;);
                if (!string.IsNullOrWhiteSpace(configPath)) options.Options[&quot;config&quot;] = configPath;
            }

            if (minScore == null)
            {
                minScore = _input.ReadOptionalInt(&quot;MinScore (opcional)&quot;);
                if (minScore.HasValue) options.Options[&quot;min-score&quot;] = minScore.Value.ToString();
            }

            if (copyFiles == null)
            {
                copyFiles = _input.ReadYesNo(&quot;Copiar arquivos encontrados?&quot;, true);
                options.Options[&quot;copy-files&quot;] = copyFiles.Value.ToString().ToLowerInvariant();
            }
        }

        // Final Validation / Defaults
        if (string.IsNullOrWhiteSpace(root))
        {
            _ui.WriteError(&quot;Root path is required (--root or --source).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(outputPath))
        {
            _ui.WriteError(&quot;Output path is required (--output or --out).&quot;);
            return 1;
        }

        // Default to true if not specified (matches original interactive default)
        copyFiles ??= true;

        var request = new HarvestRequest(
            root,
            outputPath,
            string.IsNullOrWhiteSpace(configPath) ? null : configPath,
            minScore,
            copyFiles.Value);

        using var progress = new CliProgressReporter(_ui.Theme);
        var result = await _engine.ExecuteAsync(request, progress, ct).ConfigureAwait(false);
        progress.Finish();

        // Payload Display (Tool Specific)
        if (result.IsSuccess &amp;&amp; result.Value != null)
        {
            var report = result.Value.Report;
            
            if (!options.IsNonInteractive)
            {
                if (report.Hits.Count &gt; 0)
                {
                    var showDetails = _input.ReadYesNo(&quot;Mostrar lista detalhada&quot;, false);
                    if (showDetails)
                    {
                        var limit = _input.ReadOptionalInt(&quot;Limite de itens&quot;, &quot;enter para todos&quot;) ?? report.Hits.Count;
                        _ui.Section(&quot;Top Hits&quot;);
                        foreach (var hit in report.Hits.Take(limit))
                        {
                            _ui.WriteLine($&quot;{hit.Score,6:0.0} | {hit.File}&quot;);
                            if (hit.Tags.Count &gt; 0)
                                _ui.WriteDim($&quot;  Tags: {string.Join(&quot;, &quot;, hit.Tags)}&quot;);
                            if (hit.Reasons.Count &gt; 0)
                                _ui.WriteDim($&quot;  Motivos: {string.Join(&quot; | &quot;, hit.Reasons.Take(3))}&quot;);
                        }
                    }
                }
            }
            else
            {
                // Non-Interactive (Machine Friendly)
                foreach (var hit in report.Hits)
                {
                    _ui.WriteLine($&quot;{hit.Score:0.0}\t{hit.File}&quot;);
                }
            }
        }

        _ui.PrintRunResult(result);
        return result.IsSuccess &amp;&amp; result.Summary.Failed == 0 ? 0 : 1;
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>