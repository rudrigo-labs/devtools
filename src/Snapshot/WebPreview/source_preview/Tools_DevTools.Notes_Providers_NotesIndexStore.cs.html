<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System.Text.Json;
using DevTools.Core.Abstractions;
using DevTools.Core.Providers;
using DevTools.Core.Results;
using DevTools.Notes.Models;

namespace DevTools.Notes.Providers;

public sealed class NotesIndexStore
{
    private readonly IFileSystem _fs;

    public NotesIndexStore(IFileSystem? fileSystem = null)
    {
        _fs = fileSystem ?? new SystemFileSystem();
    }

    public async Task&lt;RunResult&lt;NotesIndex&gt;&gt; LoadAsync(string root, CancellationToken ct = default)
    {
        var path = NotesPaths.IndexPath(root);
        try
        {
            if (!_fs.FileExists(path))
                return RunResult&lt;NotesIndex&gt;.Success(new NotesIndex());

            var json = await _fs.ReadAllTextAsync(path, ct).ConfigureAwait(false);
            var index = JsonSerializer.Deserialize&lt;NotesIndex&gt;(json, JsonOptions()) ?? new NotesIndex();
            index.Items ??= new List&lt;NotesIndexEntry&gt;();
            return RunResult&lt;NotesIndex&gt;.Success(index);
        }
        catch (Exception ex)
        {
            return RunResult&lt;NotesIndex&gt;.Fail(new ErrorDetail(
                &quot;notes.index.load.failed&quot;,
                &quot;Failed to load index.&quot;,
                Cause: path,
                Exception: ex));
        }
    }

    public async Task&lt;RunResult&lt;bool&gt;&gt; SaveAsync(string root, NotesIndex index, CancellationToken ct = default)
    {
        var path = NotesPaths.IndexPath(root);
        try
        {
            var dir = Path.GetDirectoryName(path);
            if (!string.IsNullOrWhiteSpace(dir))
                _fs.CreateDirectory(dir);

            var json = JsonSerializer.Serialize(index, JsonOptions());
            await _fs.WriteAllTextAsync(path, json, ct).ConfigureAwait(false);
            return RunResult&lt;bool&gt;.Success(true);
        }
        catch (Exception ex)
        {
            return RunResult&lt;bool&gt;.Fail(new ErrorDetail(
                &quot;notes.index.save.failed&quot;,
                &quot;Failed to save index.&quot;,
                Cause: path,
                Exception: ex));
        }
    }

    private static JsonSerializerOptions JsonOptions() =&gt; new()
    {
        WriteIndented = true,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>