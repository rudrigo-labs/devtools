<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Harvest.Configuration;
using DevTools.Harvest.Models;

namespace DevTools.Harvest.Engine;

internal sealed class ScoringEngine
{
    public HarvestHit Score(
        FileNode file,
        DependencyGraphBuilder.DependencyGraph graph,
        HarvestConfig config,
        IReadOnlyList&lt;KeywordDensity&gt; densities)
    {
        var weights = config.Weights;
        var tags = new List&lt;string&gt;();
        var reasons = new List&lt;string&gt;();

        var score = 0.0;

        var fanIn = graph.GetFanIn(file.FullPath);
        if (fanIn &gt; 0)
        {
            var s = fanIn * weights.FanInWeight;
            score += s;
            tags.Add(&quot;fan-in&quot;);
            reasons.Add($&quot;Fan-In: {fanIn} (+{s:0.##})&quot;);
        }

        var fanOut = graph.GetFanOut(file.FullPath);
        if (fanOut &gt; 0)
        {
            var s = fanOut * weights.FanOutWeight;
            score -= s;
            tags.Add(&quot;fan-out&quot;);
            reasons.Add($&quot;Fan-Out: {fanOut} (-{s:0.##})&quot;);
        }

        foreach (var density in densities)
        {
            if (density.Hits &lt;= 0)
                continue;

            var category = config.Categories.FirstOrDefault(c =&gt;
                string.Equals(c.Name, density.Category, StringComparison.OrdinalIgnoreCase));

            var catWeight = category?.Weight ?? 1.0;
            var s = density.Density * weights.KeywordDensityWeight * catWeight;

            if (s &lt;= 0)
                continue;

            score += s;
            tags.Add(density.Category.ToLowerInvariant());
            reasons.Add($&quot;KeywordDensity {density.Category}: {density.Hits} hits (+{s:0.##})&quot;);
        }

        if (file.PublicStaticMethodCount &gt;= weights.StaticMethodThreshold &amp;&amp; weights.StaticMethodBonus &gt; 0)
        {
            score += weights.StaticMethodBonus;
            tags.Add(&quot;static-methods&quot;);
            reasons.Add($&quot;Public static methods: {file.PublicStaticMethodCount} (+{weights.StaticMethodBonus:0.##})&quot;);
        }

        if (weights.LargeFileThresholdLines &gt; 0 &amp;&amp; file.LineCount &gt; weights.LargeFileThresholdLines &amp;&amp; weights.LargeFilePenalty &gt; 0)
        {
            score -= weights.LargeFilePenalty;
            tags.Add(&quot;large-file&quot;);
            reasons.Add($&quot;Large file: {file.LineCount} lines (-{weights.LargeFilePenalty:0.##})&quot;);
        }

        if (!file.IsEntrypointCandidate &amp;&amp; fanIn == 0 &amp;&amp; weights.DeadCodePenalty &gt; 0)
        {
            score -= weights.DeadCodePenalty;
            tags.Add(&quot;dead-code-suspect&quot;);
            reasons.Add($&quot;No references detected (-{weights.DeadCodePenalty:0.##})&quot;);
        }

        return new HarvestHit(
            file.RelativePath,
            score,
            fanIn,
            fanOut,
            tags,
            reasons,
            densities);
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>