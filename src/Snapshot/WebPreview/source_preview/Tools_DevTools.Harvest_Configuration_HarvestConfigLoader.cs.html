<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System.Reflection;
using System.Text.Json;
using DevTools.Core.Abstractions;
using DevTools.Core.Results;

namespace DevTools.Harvest.Configuration;

public static class HarvestConfigLoader
{
    private const string EmbeddedConfigName = &quot;DevTools.Harvest.Configuration.HarvestConfig.json&quot;;

    public static async Task&lt;RunResult&lt;HarvestConfig&gt;&gt; LoadAsync(
        IFileSystem fs,
        string? configPath,
        CancellationToken ct = default)
    {
        if (!string.IsNullOrWhiteSpace(configPath))
        {
            if (!fs.FileExists(configPath))
            {
                return RunResult&lt;HarvestConfig&gt;.Fail(new ErrorDetail(
                    &quot;harvest.config.not_found&quot;,
                    &quot;Config file not found.&quot;,
                    Cause: configPath,
                    Action: &quot;Provide a valid path to a JSON configuration file.&quot;));
            }

            try
            {
                var json = await fs.ReadAllTextAsync(configPath, ct).ConfigureAwait(false);
                var cfg = Deserialize(json);
                return RunResult&lt;HarvestConfig&gt;.Success(cfg);
            }
            catch (Exception ex)
            {
                return RunResult&lt;HarvestConfig&gt;.Fail(new ErrorDetail(
                    &quot;harvest.config.invalid&quot;,
                    &quot;Failed to read or parse config file.&quot;,
                    Cause: configPath,
                    Action: &quot;Check file format and permissions.&quot;,
                    Exception: ex));
            }
        }

        var embedded = ReadEmbeddedConfig();
        if (!string.IsNullOrWhiteSpace(embedded))
        {
            try
            {
                var cfg = Deserialize(embedded);
                return RunResult&lt;HarvestConfig&gt;.Success(cfg);
            }
            catch (Exception ex)
            {
                return RunResult&lt;HarvestConfig&gt;.Fail(new ErrorDetail(
                    &quot;harvest.config.embedded_invalid&quot;,
                    &quot;Failed to parse embedded config.&quot;,
                    Cause: EmbeddedConfigName,
                    Exception: ex));
            }
        }

        return RunResult&lt;HarvestConfig&gt;.Success(new HarvestConfig());
    }

    private static HarvestConfig Deserialize(string json)
    {
        var cfg = JsonSerializer.Deserialize&lt;HarvestConfig&gt;(json, new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        }) ?? new HarvestConfig();

        cfg.Normalize();
        return cfg;
    }

    private static string? ReadEmbeddedConfig()
    {
        try
        {
            var asm = Assembly.GetExecutingAssembly();
            using var stream = asm.GetManifestResourceStream(EmbeddedConfigName);
            if (stream is null) return null;

            using var reader = new StreamReader(stream);
            return reader.ReadToEnd();
        }
        catch
        {
            return null;
        }
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>