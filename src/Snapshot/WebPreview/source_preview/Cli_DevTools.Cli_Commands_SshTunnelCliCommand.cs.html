<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Cli.Ui;
using DevTools.Cli.Logging;
using DevTools.Cli.App;
using DevTools.SSHTunnel.Engine;
using DevTools.SSHTunnel.Models;
using DevTools.SSHTunnel.Providers;

namespace DevTools.Cli.Commands;

public sealed class SshTunnelCliCommand : ICliCommand
{
    private static readonly TunnelService SharedService = new(new SystemProcessRunner());
    private readonly SshTunnelEngine _engine;
    private readonly CliConsole _ui;
    private readonly CliInput _input;

    public SshTunnelCliCommand(CliConsole ui, CliInput input)
    {
        _ui = ui;
        _input = input;
        _engine = new SshTunnelEngine(SharedService);
    }

    public string Key =&gt; &quot;sshtunnel&quot;;
    public string Name =&gt; &quot;SSH Tunnel&quot;;
    public string Description =&gt; &quot;Cria e encerra tuneis SSH locais com status e perfis.&quot;;

    public async Task&lt;int&gt; ExecuteAsync(CliLaunchOptions options, CancellationToken ct)
    {
        // 1. Resolve Action
        var actionStr = options.GetOption(&quot;action&quot;);
        SshTunnelAction? action = null;
        if (actionStr != null)
        {
            if (Enum.TryParse&lt;SshTunnelAction&gt;(actionStr, true, out var a)) action = a;
            else if (actionStr.Equals(&quot;start&quot;, StringComparison.OrdinalIgnoreCase)) action = SshTunnelAction.Start;
            else if (actionStr.Equals(&quot;stop&quot;, StringComparison.OrdinalIgnoreCase)) action = SshTunnelAction.Stop;
            else if (actionStr.Equals(&quot;status&quot;, StringComparison.OrdinalIgnoreCase)) action = SshTunnelAction.Status;
        }

        if (action == null &amp;&amp; !options.IsNonInteractive)
        {
            _ui.Section(&quot;Acoes&quot;);
            _ui.WriteLine(&quot;1) Iniciar tunel&quot;);
            _ui.WriteLine(&quot;2) Parar tunel&quot;);
            _ui.WriteLine(&quot;3) Status&quot;);

            var choice = _input.ReadInt(&quot;Escolha&quot;, 1, 3);
            action = choice switch
            {
                1 =&gt; SshTunnelAction.Start,
                2 =&gt; SshTunnelAction.Stop,
                _ =&gt; SshTunnelAction.Status
            };
            options.Options[&quot;action&quot;] = action.ToString()!.ToLower();
        }

        if (action == null)
        {
            _ui.WriteError(&quot;Action required (--action start|stop|status).&quot;);
            return 1;
        }

        // 2. Resolve Parameters
        TunnelProfile? profile = null;
        if (action == SshTunnelAction.Start)
        {
            profile = ResolveProfile(options);
        }

        var request = new SshTunnelRequest(action.Value, profile);

        using var progress = new CliProgressReporter(_ui.Theme);
        var result = await _engine.ExecuteAsync(request, progress, ct).ConfigureAwait(false);
        progress.Finish();

        if (result.IsSuccess &amp;&amp; result.Value != null)
        {
            var response = result.Value;
        
        if (!options.IsNonInteractive || action == SshTunnelAction.Status)
        {
            _ui.Section(&quot;Status&quot;);
            _ui.WriteKeyValue(&quot;Estado&quot;, response.State.ToString());
            _ui.WriteKeyValue(&quot;Rodando&quot;, response.IsRunning ? &quot;Sim&quot; : &quot;Nao&quot;);
            if (response.Profile is not null)
                _ui.WriteKeyValue(&quot;Perfil&quot;, response.Profile.Name);
            if (response.ProcessId.HasValue)
                _ui.WriteKeyValue(&quot;PID&quot;, response.ProcessId.Value.ToString());
            if (!string.IsNullOrWhiteSpace(response.LastError))
                _ui.WriteWarning(response.LastError);
        }
        }

        _ui.PrintRunResult(result);
        return result.IsSuccess &amp;&amp; result.Summary.Failed == 0 ? 0 : 1;
    }

    private TunnelProfile ResolveProfile(CliLaunchOptions options)
    {
        // Args
        var name = options.GetOption(&quot;profile&quot;) ?? options.GetOption(&quot;name&quot;);
        var sshHost = options.GetOption(&quot;ssh-host&quot;) ?? options.GetOption(&quot;host&quot;);
        var sshPortStr = options.GetOption(&quot;ssh-port&quot;) ?? options.GetOption(&quot;port&quot;);
        var sshUser = options.GetOption(&quot;ssh-user&quot;) ?? options.GetOption(&quot;user&quot;);
        var localBind = options.GetOption(&quot;local-bind&quot;) ?? options.GetOption(&quot;bind&quot;);
        var localPortStr = options.GetOption(&quot;local-port&quot;);
        var remoteHost = options.GetOption(&quot;remote-host&quot;);
        var remotePortStr = options.GetOption(&quot;remote-port&quot;);
        var identity = options.GetOption(&quot;identity&quot;) ?? options.GetOption(&quot;key&quot;);
        var strictStr = options.GetOption(&quot;strict-host-key&quot;) ?? options.GetOption(&quot;strict&quot;);
        var timeoutStr = options.GetOption(&quot;timeout&quot;);

        int? sshPort = int.TryParse(sshPortStr, out var p1) ? p1 : null;
        int? localPort = int.TryParse(localPortStr, out var p2) ? p2 : null;
        int? remotePort = int.TryParse(remotePortStr, out var p3) ? p3 : null;
        int? timeout = int.TryParse(timeoutStr, out var p4) ? p4 : null;

        SshStrictHostKeyChecking strict = SshStrictHostKeyChecking.Default;
        if (strictStr != null)
        {
             if (Enum.TryParse&lt;SshStrictHostKeyChecking&gt;(strictStr, true, out var s)) strict = s;
             else if (strictStr.Equals(&quot;yes&quot;, StringComparison.OrdinalIgnoreCase)) strict = SshStrictHostKeyChecking.Yes;
             else if (strictStr.Equals(&quot;no&quot;, StringComparison.OrdinalIgnoreCase)) strict = SshStrictHostKeyChecking.No;
             else if (strictStr.Equals(&quot;accept-new&quot;, StringComparison.OrdinalIgnoreCase)) strict = SshStrictHostKeyChecking.AcceptNew;
        }

        // Interactive Fallback
        if (!options.IsNonInteractive)
        {
            if (string.IsNullOrWhiteSpace(name))
            {
                name = _input.ReadOptional(&quot;Nome do perfil&quot;, &quot;enter = default&quot;);
                if (!string.IsNullOrWhiteSpace(name)) options.Options[&quot;profile&quot;] = name;
            }
            
            if (string.IsNullOrWhiteSpace(sshHost))
            {
                sshHost = _input.ReadRequired(&quot;Host SSH&quot;, &quot;ex: 10.0.0.10&quot;);
                options.Options[&quot;ssh-host&quot;] = sshHost;
            }
            
            if (sshPort == null)
            {
                sshPort = _input.ReadOptionalInt(&quot;Porta SSH&quot;, &quot;enter = 22&quot;) ?? 22;
                options.Options[&quot;ssh-port&quot;] = sshPort.Value.ToString();
            }
            
            if (string.IsNullOrWhiteSpace(sshUser))
            {
                sshUser = _input.ReadRequired(&quot;Usuario SSH&quot;, &quot;ex: dev&quot;);
                options.Options[&quot;ssh-user&quot;] = sshUser;
            }

            if (string.IsNullOrWhiteSpace(localBind))
            {
                localBind = _input.ReadOptional(&quot;Bind local&quot;, &quot;enter = 127.0.0.1&quot;);
                if (!string.IsNullOrWhiteSpace(localBind)) options.Options[&quot;local-bind&quot;] = localBind;
            }
            
            if (localPort == null)
            {
                localPort = _input.ReadOptionalInt(&quot;Porta local&quot;, &quot;enter = 14331&quot;) ?? 14331;
                options.Options[&quot;local-port&quot;] = localPort.Value.ToString();
            }
            
            if (string.IsNullOrWhiteSpace(remoteHost))
            {
                remoteHost = _input.ReadOptional(&quot;Host remoto&quot;, &quot;enter = 127.0.0.1&quot;);
                if (!string.IsNullOrWhiteSpace(remoteHost)) options.Options[&quot;remote-host&quot;] = remoteHost;
            }
            
            if (remotePort == null)
            {
                remotePort = _input.ReadOptionalInt(&quot;Porta remota&quot;, &quot;enter = 1433&quot;) ?? 1433;
                options.Options[&quot;remote-port&quot;] = remotePort.Value.ToString();
            }

            if (string.IsNullOrWhiteSpace(identity))
            {
                identity = _input.ReadOptional(&quot;Identity file (opcional)&quot;, &quot;enter = padrao&quot;);
                if (!string.IsNullOrWhiteSpace(identity)) options.Options[&quot;identity&quot;] = identity;
            }

            if (strictStr == null)
            {
                _ui.Section(&quot;StrictHostKeyChecking&quot;);
                _ui.WriteLine(&quot;1) Default&quot;);
                _ui.WriteLine(&quot;2) Yes&quot;);
                _ui.WriteLine(&quot;3) No&quot;);
                _ui.WriteLine(&quot;4) AcceptNew&quot;);
                var strictChoice = _input.ReadInt(&quot;Escolha&quot;, 1, 4);
                strict = strictChoice switch
                {
                    2 =&gt; SshStrictHostKeyChecking.Yes,
                    3 =&gt; SshStrictHostKeyChecking.No,
                    4 =&gt; SshStrictHostKeyChecking.AcceptNew,
                    _ =&gt; SshStrictHostKeyChecking.Default
                };
                string strictVal = strict switch {
                    SshStrictHostKeyChecking.Yes =&gt; &quot;yes&quot;,
                    SshStrictHostKeyChecking.No =&gt; &quot;no&quot;,
                    SshStrictHostKeyChecking.AcceptNew =&gt; &quot;accept-new&quot;,
                    _ =&gt; &quot;default&quot;
                };
                options.Options[&quot;strict-host-key&quot;] = strictVal;
            }

            if (timeout == null)
            {
                timeout = _input.ReadOptionalInt(&quot;Timeout conexao (segundos)&quot;, &quot;enter = 10&quot;);
                if (timeout.HasValue) options.Options[&quot;timeout&quot;] = timeout.Value.ToString();
            }
        }

        // Defaults for required fields if missing in non-interactive (though strict check below will catch them)
        sshPort ??= 22;
        localPort ??= 14331;
        remotePort ??= 1433;
        
        // Validation for required fields
        if (string.IsNullOrWhiteSpace(sshHost)) throw new ArgumentException(&quot;SSH Host required (--ssh-host)&quot;);
        if (string.IsNullOrWhiteSpace(sshUser)) throw new ArgumentException(&quot;SSH User required (--ssh-user)&quot;);

        return new TunnelProfile
        {
            Name = string.IsNullOrWhiteSpace(name) ? &quot;default&quot; : name,
            SshHost = sshHost,
            SshPort = sshPort.Value,
            SshUser = sshUser,
            LocalBindHost = string.IsNullOrWhiteSpace(localBind) ? &quot;127.0.0.1&quot; : localBind,
            LocalPort = localPort.Value,
            RemoteHost = string.IsNullOrWhiteSpace(remoteHost) ? &quot;127.0.0.1&quot; : remoteHost,
            RemotePort = remotePort.Value,
            IdentityFile = string.IsNullOrWhiteSpace(identity) ? null : identity,
            StrictHostKeyChecking = strict,
            ConnectTimeoutSeconds = timeout
        };
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>