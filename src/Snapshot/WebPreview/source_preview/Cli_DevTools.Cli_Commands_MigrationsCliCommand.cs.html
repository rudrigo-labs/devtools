<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Cli.Ui;
using DevTools.Cli.Logging;
using DevTools.Cli.App;
using DevTools.Migrations.Engine;
using DevTools.Migrations.Models;

namespace DevTools.Cli.Commands;

public sealed class MigrationsCliCommand : ICliCommand
{
    private readonly CliConsole _ui;
    private readonly CliInput _input;
    private readonly MigrationsEngine _engine;

    public MigrationsCliCommand(CliConsole ui, CliInput input)
    {
        _ui = ui;
        _input = input;
        _engine = new MigrationsEngine();
    }

    public string Key =&gt; &quot;migrations&quot;;
    public string Name =&gt; &quot;Migrations&quot;;
    public string Description =&gt; &quot;Assiste o dotnet ef (add migration / update database).&quot;;

    public async Task&lt;int&gt; ExecuteAsync(CliLaunchOptions options, CancellationToken ct)
    {
        // 1. Resolve Parameters
        var actionStr = options.GetOption(&quot;action&quot;);
        var providerStr = options.GetOption(&quot;provider&quot;);
        var root = options.GetOption(&quot;root&quot;);
        var startup = options.GetOption(&quot;startup&quot;);
        var dbContext = options.GetOption(&quot;db-context&quot;) ?? options.GetOption(&quot;context&quot;);
        var migrationsProject = options.GetOption(&quot;migrations-project&quot;) ?? options.GetOption(&quot;migrations&quot;);
        var additionalArgs = options.GetOption(&quot;args&quot;);
        var migrationName = options.GetOption(&quot;migration-name&quot;) ?? options.GetOption(&quot;name&quot;);
        var dryRunStr = options.GetOption(&quot;dry-run&quot;);
        var workingDir = options.GetOption(&quot;working-dir&quot;) ?? options.GetOption(&quot;cwd&quot;);

        MigrationsAction? action = null;
        if (actionStr != null)
        {
            if (Enum.TryParse&lt;MigrationsAction&gt;(actionStr, true, out var a)) action = a;
            else if (actionStr.Equals(&quot;add&quot;, StringComparison.OrdinalIgnoreCase)) action = MigrationsAction.AddMigration;
            else if (actionStr.Equals(&quot;update&quot;, StringComparison.OrdinalIgnoreCase)) action = MigrationsAction.UpdateDatabase;
        }

        DatabaseProvider? provider = null;
        if (providerStr != null)
        {
            if (Enum.TryParse&lt;DatabaseProvider&gt;(providerStr, true, out var p)) provider = p;
            else if (providerStr.Equals(&quot;sqlserver&quot;, StringComparison.OrdinalIgnoreCase)) provider = DatabaseProvider.SqlServer;
            else if (providerStr.Equals(&quot;sqlite&quot;, StringComparison.OrdinalIgnoreCase)) provider = DatabaseProvider.Sqlite;
        }

        bool? dryRun = dryRunStr != null ? (dryRunStr == &quot;true&quot;) : null;

        // Interactive Fallback
        if (!options.IsNonInteractive)
        {
            if (action == null)
            {
                _ui.Section(&quot;Acao&quot;);
                _ui.WriteLine(&quot;1) Add migration&quot;);
                _ui.WriteLine(&quot;2) Update database&quot;);
                var actionChoice = _input.ReadInt(&quot;Escolha&quot;, 1, 2);
                action = actionChoice == 1 ? MigrationsAction.AddMigration : MigrationsAction.UpdateDatabase;
                options.Options[&quot;action&quot;] = action == MigrationsAction.AddMigration ? &quot;add&quot; : &quot;update&quot;;
            }

            if (provider == null)
            {
                _ui.Section(&quot;Provider&quot;);
                _ui.WriteLine(&quot;1) SqlServer&quot;);
                _ui.WriteLine(&quot;2) Sqlite&quot;);
                var providerChoice = _input.ReadInt(&quot;Escolha&quot;, 1, 2);
                provider = providerChoice == 2 ? DatabaseProvider.Sqlite : DatabaseProvider.SqlServer;
                options.Options[&quot;provider&quot;] = provider == DatabaseProvider.Sqlite ? &quot;sqlite&quot; : &quot;sqlserver&quot;;
            }

            if (string.IsNullOrWhiteSpace(root))
            {
                root = _input.ReadRequired(&quot;Root do projeto&quot;, &quot;ex: C:\\Projetos\\MeuApp&quot;);
                options.Options[&quot;root&quot;] = root;
            }
            
            if (string.IsNullOrWhiteSpace(startup))
            {
                startup = _input.ReadRequired(&quot;Projeto startup (.csproj)&quot;, &quot;ex: C:\\Projetos\\MeuApp\\Api.csproj&quot;);
                options.Options[&quot;startup&quot;] = startup;
            }
            
            if (string.IsNullOrWhiteSpace(dbContext))
            {
                dbContext = _input.ReadRequired(&quot;DbContext (namespace completo)&quot;, &quot;ex: MeuApp.Data.AppDbContext&quot;);
                options.Options[&quot;db-context&quot;] = dbContext;
            }
            
            if (string.IsNullOrWhiteSpace(migrationsProject))
            {
                migrationsProject = _input.ReadRequired(&quot;Projeto migrations (.csproj)&quot;, &quot;ex: C:\\Projetos\\MeuApp\\Data.csproj&quot;);
                options.Options[&quot;migrations-project&quot;] = migrationsProject;
            }
            
            if (string.IsNullOrWhiteSpace(additionalArgs))
            {
                additionalArgs = _input.ReadOptional(&quot;Args adicionais (opcional)&quot;);
                if (!string.IsNullOrWhiteSpace(additionalArgs)) options.Options[&quot;args&quot;] = additionalArgs;
            }

            if (action == MigrationsAction.AddMigration &amp;&amp; string.IsNullOrWhiteSpace(migrationName))
            {
                migrationName = _input.ReadRequired(&quot;Nome da migration&quot;);
                options.Options[&quot;migration-name&quot;] = migrationName;
            }
            
            if (dryRun == null)
            {
                dryRun = _input.ReadYesNo(&quot;Dry-run&quot;, true);
                options.Options[&quot;dry-run&quot;] = dryRun.Value.ToString().ToLower();
            }
            
            if (string.IsNullOrWhiteSpace(workingDir))
            {
                workingDir = _input.ReadOptional(&quot;Working directory (opcional)&quot;, &quot;enter = usar root&quot;);
                if (!string.IsNullOrWhiteSpace(workingDir)) options.Options[&quot;working-dir&quot;] = workingDir;
            }
        }

        // Defaults
        dryRun ??= false;

        // Validation
        if (action == null)
        {
             _ui.WriteError(&quot;Action required (--action add|update).&quot;);
             return 1;
        }
        if (provider == null)
        {
            _ui.WriteError(&quot;Provider required (--provider sqlserver|sqlite).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(root))
        {
            _ui.WriteError(&quot;Root path required (--root).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(startup))
        {
            _ui.WriteError(&quot;Startup project required (--startup).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(dbContext))
        {
            _ui.WriteError(&quot;DbContext required (--db-context).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(migrationsProject))
        {
            _ui.WriteError(&quot;Migrations project required (--migrations-project).&quot;);
            return 1;
        }
        if (action == MigrationsAction.AddMigration &amp;&amp; string.IsNullOrWhiteSpace(migrationName))
        {
            _ui.WriteError(&quot;Migration name required for &#39;add&#39; action (--migration-name).&quot;);
            return 1;
        }

        var settings = new MigrationsSettings
        {
            RootPath = root,
            StartupProjectPath = startup,
            DbContextFullName = dbContext,
            AdditionalArgs = string.IsNullOrWhiteSpace(additionalArgs) ? null : additionalArgs,
            Targets = new List&lt;MigrationTarget&gt;
            {
                new MigrationTarget
                {
                    Provider = provider.Value,
                    MigrationsProjectPath = migrationsProject
                }
            }
        };

        var request = new MigrationsRequest(
            action.Value,
            provider.Value,
            settings,
            migrationName,
            dryRun.Value,
            string.IsNullOrWhiteSpace(workingDir) ? null : workingDir);

        using var progress = new CliProgressReporter(_ui.Theme);
        var result = await _engine.ExecuteAsync(request, progress, ct).ConfigureAwait(false);
        progress.Finish();

        if (!result.IsSuccess || result.Value is null)
        {
            WriteErrors(result.Errors);
            return 1;
        }

        var response = result.Value;
        
        if (!options.IsNonInteractive)
        {
            _ui.Section(&quot;Resumo&quot;);
            _ui.WriteKeyValue(&quot;Comando&quot;, response.Command);
            if (response.WasDryRun)
            {
                _ui.WriteWarning(&quot;Dry-run: comando nao executado.&quot;);
                return 0;
            }

            if (!string.IsNullOrWhiteSpace(response.StdOut))
            {
                _ui.Section(&quot;StdOut&quot;);
                _ui.WriteLine(response.StdOut.Trim());
            }

            if (!string.IsNullOrWhiteSpace(response.StdErr))
            {
                _ui.Section(&quot;StdErr&quot;);
                _ui.WriteWarning(response.StdErr.Trim());
            }
        }

        return response.ExitCode == 0 ? 0 : 1;
    }

    private void WriteErrors(IReadOnlyList&lt;DevTools.Core.Results.ErrorDetail&gt; errors)
    {
        CliErrorLogger.LogErrors(Key, errors);
        _ui.Section(&quot;Erros&quot;);
        foreach (var error in errors)
        {
            _ui.WriteError($&quot;{error.Code}: {error.Message}&quot;);
            if (!string.IsNullOrWhiteSpace(error.Details))
                _ui.WriteDim(error.Details);
        }
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>