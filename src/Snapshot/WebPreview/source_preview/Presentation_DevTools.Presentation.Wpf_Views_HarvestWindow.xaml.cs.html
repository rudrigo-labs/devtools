<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System;
using System.Linq;
using System.Windows;
using System.Collections.Generic;
using DevTools.Harvest.Engine;
using DevTools.Harvest.Models;
using DevTools.Presentation.Wpf.Services;
using DevTools.Core.Models;

namespace DevTools.Presentation.Wpf.Views;

public partial class HarvestWindow : Window
{
    private readonly JobManager _jobManager;
    private readonly SettingsService _settingsService;
    public HarvestRequest? Result { get; private set; }

    public HarvestWindow(JobManager jobManager, SettingsService settingsService)
    {
        InitializeComponent();
        _jobManager = jobManager;
        _settingsService = settingsService;

        ProfileSelector.GetOptionsFunc = GetCurrentOptions;
        ProfileSelector.ProfileLoaded += LoadProfile;

        // Carregar configura&#231;&#245;es salvas
        if (!string.IsNullOrEmpty(_settingsService.Settings.LastHarvestSourcePath))
            SourcePathSelector.SelectedPath = _settingsService.Settings.LastHarvestSourcePath;
            
        if (!string.IsNullOrEmpty(_settingsService.Settings.LastHarvestOutputPath))
            OutputPathSelector.SelectedPath = _settingsService.Settings.LastHarvestOutputPath;

        if (!string.IsNullOrEmpty(_settingsService.Settings.LastHarvestConfigPath))
            ConfigPathSelector.SelectedPath = _settingsService.Settings.LastHarvestConfigPath;

        if (_settingsService.Settings.LastHarvestMinScore.HasValue)
            MinScoreBox.Text = _settingsService.Settings.LastHarvestMinScore.Value.ToString();

        if (_settingsService.Settings.LastHarvestCopyFiles.HasValue)
            CopyFilesCheck.IsChecked = _settingsService.Settings.LastHarvestCopyFiles.Value;
        
        // Posicionar no canto inferior direito e fechar ao perder foco
        /* Position handled by TrayService
        Loaded += (s, e) =&gt; 
        {
            var desktopWorkingArea = SystemParameters.WorkArea;
            this.Left = desktopWorkingArea.Right - this.ActualWidth - 20;
            this.Top = desktopWorkingArea.Bottom - this.ActualHeight - 20;
            this.Activate();
        };
        */

        // Comportamento estilo Tray: Fechar ao clicar fora
        this.Deactivated += (s, e) =&gt; 
        {
            // Se o usu&#225;rio clicar fora, fecha a janela (como um menu)
            // Mas apenas se n&#227;o estiver abrindo um di&#225;logo filho (como o PathSelector)
            // TODO: Refinar l&#243;gica se PathSelector causar Deactivate. Por enquanto, simplificado.
            // this.Close(); 
            // Comentado pois o FolderBrowserDialog causa Deactivate. Precisamos de flag.
        };
    }

    private Dictionary&lt;string, string&gt; GetCurrentOptions()
    {
        var options = new Dictionary&lt;string, string&gt;();
        options[&quot;root&quot;] = SourcePathSelector.SelectedPath;
        options[&quot;output&quot;] = OutputPathSelector.SelectedPath;
        options[&quot;config&quot;] = ConfigPathSelector.SelectedPath;
        options[&quot;min-score&quot;] = MinScoreBox.Text;
        options[&quot;copy&quot;] = (CopyFilesCheck.IsChecked ?? true).ToString().ToLowerInvariant();
        return options;
    }

    private void LoadProfile(ToolProfile profile)
    {
        if (profile.Options.TryGetValue(&quot;root&quot;, out var root)) SourcePathSelector.SelectedPath = root;
        if (profile.Options.TryGetValue(&quot;output&quot;, out var output)) OutputPathSelector.SelectedPath = output;
        if (profile.Options.TryGetValue(&quot;config&quot;, out var config)) ConfigPathSelector.SelectedPath = config;
        
        if (profile.Options.TryGetValue(&quot;min-score&quot;, out var minScore))
             MinScoreBox.Text = minScore;
             
        if (profile.Options.TryGetValue(&quot;copy&quot;, out var copy))
             CopyFilesCheck.IsChecked = bool.TryParse(copy, out var c) ? c : true;
    }

    private async void Run_Click(object sender, RoutedEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(SourcePathSelector.SelectedPath))
        {
            MessageBox.Show(&quot;Por favor, selecione um diret&#243;rio de origem.&quot;, &quot;Erro de Valida&#231;&#227;o&quot;, MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(OutputPathSelector.SelectedPath))
        {
            MessageBox.Show(&quot;Por favor, selecione um diret&#243;rio de destino.&quot;, &quot;Erro de Valida&#231;&#227;o&quot;, MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        // Salvar configura&#231;&#245;es apenas se opt-in
        if (RememberSettingsCheck.IsChecked == true)
        {
            _settingsService.Settings.LastHarvestSourcePath = SourcePathSelector.SelectedPath;
            _settingsService.Settings.LastHarvestOutputPath = OutputPathSelector.SelectedPath;
            _settingsService.Settings.LastHarvestConfigPath = ConfigPathSelector.SelectedPath;
            
            if (int.TryParse(MinScoreBox.Text, out var minScore))
                 _settingsService.Settings.LastHarvestMinScore = minScore;
    
            _settingsService.Settings.LastHarvestCopyFiles = CopyFilesCheck.IsChecked;
            _settingsService.Save();
        }

        Result = new HarvestRequest(
            RootPath: SourcePathSelector.SelectedPath,
            OutputPath: OutputPathSelector.SelectedPath,
            ConfigPath: ConfigPathSelector.SelectedPath,
            MinScore: int.TryParse(MinScoreBox.Text, out var ms) ? ms : 0,
            CopyFiles: CopyFilesCheck.IsChecked ?? true
        );

        // Execute directly to show result in-place
        var engine = new HarvestEngine();
        
        // Disable UI while running
        IsEnabled = false;
        RunSummary.Clear();
        
        try 
        {
            // Simple progress reporter could be added here if needed, 
            // but for now we just await the result.
            var result = await System.Threading.Tasks.Task.Run(() =&gt; engine.ExecuteAsync(Result));
            
            RunSummary.BindResult(result);
            
            // If successful and not user cancelled, maybe we don&#39;t close immediately 
            // so user can see the summary.
            // If we wanted to &quot;fire and forget&quot; via JobManager, we would do that instead.
            // But requirement is &quot;WPF mostra status e permite ver detalhes&quot;.
            
        }
        catch (Exception ex)
        {
             MessageBox.Show($&quot;Erro cr&#237;tico ao executar: {ex.Message}&quot;, &quot;Erro&quot;, MessageBoxButton.OK, MessageBoxImage.Error);
        }
        finally
        {
            IsEnabled = true;
        }
    }
    
    private void Header_MouseLeftButtonDown(object sender, System.Windows.Input.MouseButtonEventArgs e)
    {
        // DragMove();
    }

    private void Cancel_Click(object sender, RoutedEventArgs e)
    {
        Close();
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>