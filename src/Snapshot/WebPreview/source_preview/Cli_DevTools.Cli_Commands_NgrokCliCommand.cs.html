<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Cli.Ui;
using DevTools.Cli.Logging;
using DevTools.Cli.App;
using DevTools.Ngrok.Engine;
using DevTools.Ngrok.Models;

namespace DevTools.Cli.Commands;

public sealed class NgrokCliCommand : ICliCommand
{
    private readonly CliConsole _ui;
    private readonly CliInput _input;
    private readonly NgrokEngine _engine;

    public NgrokCliCommand(CliConsole ui, CliInput input)
    {
        _ui = ui;
        _input = input;
        _engine = new NgrokEngine();
    }

    public string Key =&gt; &quot;ngrok&quot;;
    public string Name =&gt; &quot;Ngrok&quot;;
    public string Description =&gt; &quot;Gerencia tuneis do ngrok (listar, iniciar, fechar, status).&quot;;

    public async Task&lt;int&gt; ExecuteAsync(CliLaunchOptions options, CancellationToken ct)
    {
        // 1. Resolve Parameters
        var actionStr = options.GetOption(&quot;action&quot;);
        var baseUrl = options.GetOption(&quot;base-url&quot;) ?? options.GetOption(&quot;url&quot;);
        var timeoutStr = options.GetOption(&quot;timeout&quot;);
        var retryStr = options.GetOption(&quot;retry&quot;);
        var tunnelName = options.GetOption(&quot;tunnel-name&quot;) ?? options.GetOption(&quot;name&quot;);
        var protocol = options.GetOption(&quot;protocol&quot;) ?? options.GetOption(&quot;proto&quot;);
        var portStr = options.GetOption(&quot;port&quot;);
        var ngrokPath = options.GetOption(&quot;ngrok-path&quot;) ?? options.GetOption(&quot;path&quot;);
        var extraArgsStr = options.GetOption(&quot;extra-args&quot;) ?? options.GetOption(&quot;args&quot;);

        int? timeout = int.TryParse(timeoutStr, out var parsedTimeout) ? parsedTimeout : null;
        int? retry = int.TryParse(retryStr, out var parsedRetry) ? parsedRetry : null;
        int? port = int.TryParse(portStr, out var parsedPort) ? parsedPort : null;

        NgrokAction? action = null;
        if (actionStr != null)
        {
            if (Enum.TryParse&lt;NgrokAction&gt;(actionStr, true, out var parsedAction)) action = parsedAction;
            else if (actionStr.Equals(&quot;list&quot;, StringComparison.OrdinalIgnoreCase)) action = NgrokAction.ListTunnels;
            else if (actionStr.Equals(&quot;close&quot;, StringComparison.OrdinalIgnoreCase)) action = NgrokAction.CloseTunnel;
            else if (actionStr.Equals(&quot;start&quot;, StringComparison.OrdinalIgnoreCase)) action = NgrokAction.StartHttp;
            else if (actionStr.Equals(&quot;kill&quot;, StringComparison.OrdinalIgnoreCase)) action = NgrokAction.KillAll;
            else if (actionStr.Equals(&quot;status&quot;, StringComparison.OrdinalIgnoreCase)) action = NgrokAction.Status;
        }

        // Interactive Fallback
        if (!options.IsNonInteractive)
        {
            if (action == null)
            {
                _ui.Section(&quot;Acoes&quot;);
                _ui.WriteLine(&quot;1) Listar tuneis&quot;);
                _ui.WriteLine(&quot;2) Fechar tunel&quot;);
                _ui.WriteLine(&quot;3) Start HTTP&quot;);
                _ui.WriteLine(&quot;4) Kill all&quot;);
                _ui.WriteLine(&quot;5) Status&quot;);

                var choice = _input.ReadInt(&quot;Escolha&quot;, 1, 5);
                action = choice switch
                {
                    1 =&gt; NgrokAction.ListTunnels,
                    2 =&gt; NgrokAction.CloseTunnel,
                    3 =&gt; NgrokAction.StartHttp,
                    4 =&gt; NgrokAction.KillAll,
                    _ =&gt; NgrokAction.Status
                };
                options.Options[&quot;action&quot;] = action.ToString()!.ToLower();
            }

            if (string.IsNullOrWhiteSpace(baseUrl))
            {
                baseUrl = _input.ReadOptional(&quot;BaseUrl API (opcional)&quot;, &quot;enter = http://127.0.0.1:4040/&quot;);
                if (!string.IsNullOrWhiteSpace(baseUrl)) options.Options[&quot;base-url&quot;] = baseUrl;
            }
            
            if (timeout == null)
            {
                timeout = _input.ReadOptionalInt(&quot;Timeout (segundos)&quot;, &quot;enter = 5&quot;) ?? 5;
                options.Options[&quot;timeout&quot;] = timeout.Value.ToString();
            }
            
            if (retry == null)
            {
                retry = _input.ReadOptionalInt(&quot;Retry count&quot;, &quot;enter = 1&quot;) ?? 1;
                options.Options[&quot;retry&quot;] = retry.Value.ToString();
            }

            if (action == NgrokAction.CloseTunnel &amp;&amp; string.IsNullOrWhiteSpace(tunnelName))
            {
                tunnelName = _input.ReadRequired(&quot;Nome do tunel&quot;);
                options.Options[&quot;tunnel-name&quot;] = tunnelName;
            }
            else if (action == NgrokAction.StartHttp)
            {
                if (string.IsNullOrWhiteSpace(protocol))
                {
                    protocol = _input.ReadOptional(&quot;Protocolo&quot;, &quot;http/https (enter = http)&quot;);
                    if (!string.IsNullOrWhiteSpace(protocol)) options.Options[&quot;protocol&quot;] = protocol;
                }
                
                if (port == null)
                {
                    port = _input.ReadOptionalInt(&quot;Porta&quot;, &quot;enter = 80&quot;) ?? 80;
                    options.Options[&quot;port&quot;] = port.Value.ToString();
                }
                
                if (string.IsNullOrWhiteSpace(ngrokPath))
                {
                    ngrokPath = _input.ReadOptional(&quot;Caminho do ngrok (opcional)&quot;, &quot;enter = default&quot;);
                    if (!string.IsNullOrWhiteSpace(ngrokPath)) options.Options[&quot;ngrok-path&quot;] = ngrokPath;
                }
                
                if (string.IsNullOrWhiteSpace(extraArgsStr))
                {
                    var extraList = _input.ReadCsv(&quot;Args extras (opcional)&quot;, &quot;ex: --region=sa&quot;);
                    if (extraList.Count &gt; 0)
                    {
                        extraArgsStr = string.Join(&quot;,&quot;, extraList);
                        options.Options[&quot;extra-args&quot;] = extraArgsStr;
                    }
                }
            }
        }

        // Defaults
        timeout ??= 5;
        retry ??= 1;

        // Validation
        if (action == null)
        {
            _ui.WriteError(&quot;Action required (--action list|close|start|kill|status).&quot;);
            return 1;
        }
        if (action == NgrokAction.CloseTunnel &amp;&amp; string.IsNullOrWhiteSpace(tunnelName))
        {
            _ui.WriteError(&quot;Tunnel name required for close action (--tunnel-name).&quot;);
            return 1;
        }
        if (action == NgrokAction.StartHttp &amp;&amp; port == null)
        {
            port = 80; // default if somehow missed
        }

        NgrokStartOptions? startOptions = null;
        if (action == NgrokAction.StartHttp)
        {
            var argsList = !string.IsNullOrWhiteSpace(extraArgsStr) 
                ? extraArgsStr.Split(&#39;,&#39;, StringSplitOptions.RemoveEmptyEntries).Select(s =&gt; s.Trim()).ToList() 
                : null;

            startOptions = new NgrokStartOptions(
                string.IsNullOrWhiteSpace(protocol) ? &quot;http&quot; : protocol,
                port!.Value,
                string.IsNullOrWhiteSpace(ngrokPath) ? null : ngrokPath,
                argsList);
        }

        var request = new NgrokRequest(
            action.Value,
            string.IsNullOrWhiteSpace(baseUrl) ? null : baseUrl,
            timeout.Value,
            retry.Value,
            tunnelName,
            startOptions);

        using var progress = new CliProgressReporter(_ui.Theme);
        var result = await _engine.ExecuteAsync(request, progress, ct).ConfigureAwait(false);
        progress.Finish();

        if (result.IsSuccess &amp;&amp; result.Value != null)
        {
            var response = result.Value;
        
        if (!options.IsNonInteractive || action == NgrokAction.ListTunnels || action == NgrokAction.Status)
        {
            _ui.Section(&quot;Resultado&quot;);
            if (action == NgrokAction.ListTunnels &amp;&amp; response.Tunnels is not null)
            {
                foreach (var t in response.Tunnels)
                    _ui.WriteLine($&quot;{t.Name} | {t.PublicUrl} | {t.Proto} -&gt; {t.Addr}&quot;);
            }
            else if (action == NgrokAction.CloseTunnel)
            {
                _ui.WriteLine(response.Closed == true ? &quot;Tunel fechado.&quot; : &quot;Tunel nao encontrado.&quot;);
            }
            else if (action == NgrokAction.StartHttp)
            {
                _ui.WriteLine(response.ProcessId.HasValue
                    ? $&quot;Ngrok iniciado. PID: {response.ProcessId}&quot;
                    : &quot;Ngrok iniciado.&quot;);
            }
            else if (action == NgrokAction.KillAll)
            {
                _ui.WriteLine(response.Killed.HasValue
                    ? $&quot;Processos encerrados: {response.Killed}&quot;
                    : &quot;Nenhum processo encontrado.&quot;);
            }
            else if (action == NgrokAction.Status)
            {
                _ui.WriteLine(response.HasAny == true ? &quot;Ngrok esta em execucao.&quot; : &quot;Ngrok nao encontrado.&quot;);
            }
        }
        }

        _ui.PrintRunResult(result);
        return result.IsSuccess &amp;&amp; result.Summary.Failed == 0 ? 0 : 1;
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>