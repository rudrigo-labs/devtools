<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System;
using System.Linq;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Input;
using System.Collections.Generic;
using DevTools.Image.Engine;
using DevTools.Image.Models;
using DevTools.Presentation.Wpf.Services;
using DevTools.Core.Models;
using Microsoft.Win32;

namespace DevTools.Presentation.Wpf.Views;

public partial class ImageSplitWindow : Window
{
    private readonly JobManager _jobManager;
    private readonly SettingsService _settingsService;

    public ImageSplitWindow(JobManager jobManager, SettingsService settingsService)
    {
        InitializeComponent();
        _jobManager = jobManager;
        _settingsService = settingsService;

        ProfileSelector.GetOptionsFunc = GetCurrentOptions;
        ProfileSelector.ProfileLoaded += LoadProfile;

        // Restore Settings
        if (!string.IsNullOrEmpty(_settingsService.Settings.LastImageSplitInputPath))
            InputPathBox.Text = _settingsService.Settings.LastImageSplitInputPath;
        
        if (!string.IsNullOrEmpty(_settingsService.Settings.LastImageSplitOutputDir))
            OutputPathBox.Text = _settingsService.Settings.LastImageSplitOutputDir;

        // Restore Position
        /* Position handled by TrayService
        if (_settingsService.Settings.ImageSplitWindowTop.HasValue)
        {
            Top = _settingsService.Settings.ImageSplitWindowTop.Value;
            Left = _settingsService.Settings.ImageSplitWindowLeft.Value;
        }
        else
        {
            // Default: Bottom-Right
            var screen = SystemParameters.WorkArea;
            Left = screen.Right - Width - 20;
            Top = screen.Bottom - Height - 20;
        }

        // Safety check
        var workArea = SystemParameters.WorkArea;
        if (Top &lt; 0 || Top &gt; workArea.Height) Top = workArea.Height - Height - 20;
        if (Left &lt; 0 || Left &gt; workArea.Width) Left = workArea.Width - Width - 20;
        */

        // Auto-Save Position on Close
        /*
        Closed += (s, e) =&gt;
        {
            _settingsService.Settings.ImageSplitWindowTop = Top;
            _settingsService.Settings.ImageSplitWindowLeft = Left;
            _settingsService.Save();
        };
        */
    }

    private Dictionary&lt;string, string&gt; GetCurrentOptions()
    {
        var options = new Dictionary&lt;string, string&gt;();
        options[&quot;input&quot;] = InputPathBox.Text;
        options[&quot;output&quot;] = OutputPathBox.Text;
        options[&quot;alpha&quot;] = AlphaBox.Text;
        options[&quot;min-w&quot;] = MinSizeBox.Text;
        options[&quot;min-h&quot;] = MinSizeBox.Text; // UI uses single size box for both
        options[&quot;overwrite&quot;] = (OverwriteCheck.IsChecked ?? false).ToString().ToLowerInvariant();
        return options;
    }

    private void LoadProfile(ToolProfile profile)
    {
        if (profile.Options.TryGetValue(&quot;input&quot;, out var input)) InputPathBox.Text = input;
        else if (profile.Options.TryGetValue(&quot;file&quot;, out var file)) InputPathBox.Text = file;
        
        if (profile.Options.TryGetValue(&quot;output&quot;, out var output)) OutputPathBox.Text = output;
        
        if (profile.Options.TryGetValue(&quot;alpha&quot;, out var alpha)) AlphaBox.Text = alpha;
        else if (profile.Options.TryGetValue(&quot;threshold&quot;, out var threshold)) AlphaBox.Text = threshold;
        
        if (profile.Options.TryGetValue(&quot;min-w&quot;, out var minW)) MinSizeBox.Text = minW;
        else if (profile.Options.TryGetValue(&quot;width&quot;, out var width)) MinSizeBox.Text = width;
        
        if (profile.Options.TryGetValue(&quot;overwrite&quot;, out var overwrite))
             OverwriteCheck.IsChecked = bool.TryParse(overwrite, out var o) ? o : false;
    }

    private void Header_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        // if (e.ButtonState == MouseButtonState.Pressed)
        //    DragMove();
    }

    private void CloseButton_Click(object sender, RoutedEventArgs e)
    {
        Close();
    }

    private void BrowseInput_Click(object sender, RoutedEventArgs e)
    {
        var dlg = new OpenFileDialog
        {
            Filter = &quot;Imagens (*.png;*.jpg;*.jpeg;*.bmp)|*.png;*.jpg;*.jpeg;*.bmp|Todos os Arquivos (*.*)|*.*&quot;,
            Title = &quot;Selecione a Imagem para Recortar&quot;
        };

        if (dlg.ShowDialog() == true)
        {
            InputPathBox.Text = dlg.FileName;
            _settingsService.Settings.LastImageSplitInputPath = dlg.FileName;
            _settingsService.Save();
        }
    }

    private void BrowseOutput_Click(object sender, RoutedEventArgs e)
    {
        var dlg = new OpenFolderDialog
        {
            Title = &quot;Selecione a Pasta de Sa&#237;da&quot;
        };

        if (dlg.ShowDialog() == true)
        {
            OutputPathBox.Text = dlg.FolderName;
            _settingsService.Settings.LastImageSplitOutputDir = dlg.FolderName;
            _settingsService.Save();
        }
    }

    private void NumberValidationTextBox(object sender, TextCompositionEventArgs e)
    {
        e.Handled = !IsTextAllowed(e.Text);
    }

    private static bool IsTextAllowed(string text)
    {
        return Regex.IsMatch(text, &quot;[0-9]+&quot;);
    }

    private void ProcessButton_Click(object sender, RoutedEventArgs e)
    {
        var inputPath = InputPathBox.Text;
        var outputPath = OutputPathBox.Text;
        
        if (string.IsNullOrWhiteSpace(inputPath))
        {
            MessageBox.Show(&quot;Por favor, selecione uma imagem de entrada.&quot;, &quot;Campo Obrigat&#243;rio&quot;, MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        if (!byte.TryParse(AlphaBox.Text, out var alpha)) alpha = 10;
        if (!int.TryParse(MinSizeBox.Text, out var minSize)) minSize = 3;
        var overwrite = OverwriteCheck.IsChecked ?? false;

        // Close window to start job
        Close();

        _jobManager.StartJob(&quot;ImageSplitter&quot;, async (reporter, ct) =&gt;
        {
            var engine = new ImageSplitEngine();
            var request = new ImageSplitRequest(
                InputPath: inputPath,
                OutputDirectory: outputPath,
                AlphaThreshold: alpha,
                MinRegionWidth: minSize,
                MinRegionHeight: minSize,
                Overwrite: overwrite
            );

            var result = await engine.ExecuteAsync(request, reporter, ct);

            return result.IsSuccess
                ? $&quot;Recorte conclu&#237;do! {result.Value?.TotalComponents ?? 0} partes geradas.&quot;
                : $&quot;Falha no recorte: {string.Join(&quot;, &quot;, result.Errors.Select(e =&gt; e.Message))}&quot;;
        });
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>