<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Cli.Ui;
using DevTools.Cli.Logging;
using DevTools.Rename.Engine;
using DevTools.Rename.Models;
using DevTools.Cli.App;

namespace DevTools.Cli.Commands;

public sealed class RenameCliCommand : ICliCommand
{
    private readonly CliConsole _ui;
    private readonly CliInput _input;
    private readonly RenameEngine _engine;

    public RenameCliCommand(CliConsole ui, CliInput input)
    {
        _ui = ui;
        _input = input;
        _engine = new RenameEngine();
    }

    public string Key =&gt; &quot;rename&quot;;
    public string Name =&gt; &quot;Rename&quot;;
    public string Description =&gt; &quot;Renomeia identificadores/arquivos C# com backup e undo.&quot;;

    public async Task&lt;int&gt; ExecuteAsync(CliLaunchOptions options, CancellationToken ct)
    {
        // 1. Resolve Parameters
        var root = options.GetOption(&quot;root&quot;) ?? options.GetOption(&quot;source&quot;);
        var oldText = options.GetOption(&quot;old-text&quot;) ?? options.GetOption(&quot;old&quot;) ?? options.GetOption(&quot;from&quot;);
        var newText = options.GetOption(&quot;new-text&quot;) ?? options.GetOption(&quot;new&quot;) ?? options.GetOption(&quot;to&quot;);
        
        var modeStr = options.GetOption(&quot;mode&quot;);
        RenameMode? mode = null;
        if (modeStr != null)
        {
            if (modeStr.Equals(&quot;namespace&quot;, StringComparison.OrdinalIgnoreCase) || modeStr == &quot;2&quot;)
                mode = RenameMode.NamespaceOnly;
            else
                mode = RenameMode.General;
        }

        var dryRunStr = options.GetOption(&quot;dry-run&quot;) ?? options.GetOption(&quot;dry&quot;);
        bool? dryRun = dryRunStr != null ? (dryRunStr == &quot;true&quot;) : null;

        var backupStr = options.GetOption(&quot;backup&quot;);
        bool? backup = backupStr != null ? (backupStr == &quot;true&quot;) : null;

        var undoLogStr = options.GetOption(&quot;undo-log&quot;) ?? options.GetOption(&quot;undo&quot;);
        bool? undoLog = undoLogStr != null ? (undoLogStr == &quot;true&quot;) : null;

        var includeStr = options.GetOption(&quot;include&quot;) ?? options.GetOption(&quot;inc&quot;);
        var excludeStr = options.GetOption(&quot;exclude&quot;) ?? options.GetOption(&quot;exc&quot;);

        List&lt;string&gt;? include = null;
        if (!string.IsNullOrWhiteSpace(includeStr))
        {
            include = includeStr.Split(new[] { &#39;,&#39;, &#39;;&#39; }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }

        List&lt;string&gt;? exclude = null;
        if (!string.IsNullOrWhiteSpace(excludeStr))
        {
            exclude = excludeStr.Split(new[] { &#39;,&#39;, &#39;;&#39; }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        }

        // Interactive Fallback
        if (!options.IsNonInteractive)
        {
            if (string.IsNullOrWhiteSpace(root))
            {
                root = _input.ReadRequired(&quot;Pasta raiz&quot;, &quot;ex: C:\\Projetos\\MeuApp&quot;);
                options.Options[&quot;root&quot;] = root;
            }
            
            if (string.IsNullOrWhiteSpace(oldText))
            {
                oldText = _input.ReadRequired(&quot;Texto antigo&quot;);
                options.Options[&quot;old-text&quot;] = oldText;
            }
            
            if (string.IsNullOrWhiteSpace(newText))
            {
                newText = _input.ReadRequired(&quot;Texto novo&quot;);
                options.Options[&quot;new-text&quot;] = newText;
            }

            if (mode == null)
            {
                _ui.Section(&quot;Modo&quot;);
                _ui.WriteLine(&quot;1) Geral (identificadores C#)&quot;);
                _ui.WriteLine(&quot;2) Apenas namespace&quot;);
                var modeChoice = _input.ReadInt(&quot;Escolha&quot;, 1, 2);
                mode = modeChoice == 2 ? RenameMode.NamespaceOnly : RenameMode.General;
                options.Options[&quot;mode&quot;] = modeChoice == 2 ? &quot;namespace&quot; : &quot;general&quot;;
            }

            if (dryRun == null)
            {
                dryRun = _input.ReadYesNo(&quot;Dry-run&quot;, true);
                options.Options[&quot;dry-run&quot;] = dryRun.Value.ToString().ToLowerInvariant();
            }
            
            if (backup == null)
            {
                backup = _input.ReadYesNo(&quot;Criar backup&quot;, true);
                options.Options[&quot;backup&quot;] = backup.Value.ToString().ToLowerInvariant();
            }
            
            if (undoLog == null)
            {
                undoLog = _input.ReadYesNo(&quot;Gerar undo log&quot;, true);
                options.Options[&quot;undo-log&quot;] = undoLog.Value.ToString().ToLowerInvariant();
            }

            if (include == null)
            {
                var list = _input.ReadCsv(&quot;Includes (globs)&quot;, &quot;ex: src/**/*.cs&quot;);
                if (list.Count &gt; 0) 
                {
                    include = list.ToList();
                    options.Options[&quot;include&quot;] = string.Join(&quot;,&quot;, include);
                }
            }

            if (exclude == null)
            {
                var list = _input.ReadCsv(&quot;Excludes (globs)&quot;, &quot;ex: bin/**, obj/**&quot;);
                if (list.Count &gt; 0) 
                {
                    exclude = list.ToList();
                    options.Options[&quot;exclude&quot;] = string.Join(&quot;,&quot;, exclude);
                }
            }
        }

        // Final Validation / Defaults
        if (string.IsNullOrWhiteSpace(root))
        {
            _ui.WriteError(&quot;Root path is required (--root).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(oldText))
        {
            _ui.WriteError(&quot;Old text is required (--old).&quot;);
            return 1;
        }
        if (string.IsNullOrWhiteSpace(newText))
        {
            _ui.WriteError(&quot;New text is required (--new).&quot;);
            return 1;
        }

        mode ??= RenameMode.General;
        dryRun ??= true;
        backup ??= true;
        undoLog ??= true;

        var request = new RenameRequest(
            root,
            oldText,
            newText,
            mode.Value,
            dryRun.Value,
            include?.Count &gt; 0 ? include : null,
            exclude?.Count &gt; 0 ? exclude : null,
            backup.Value,
            undoLog.Value,
            null,
            null,
            200);

        using var progress = new CliProgressReporter(_ui.Theme);
        var result = await _engine.ExecuteAsync(request, progress, ct).ConfigureAwait(false);
        progress.Finish();

        // Payload Display
        if (result.IsSuccess &amp;&amp; result.Value != null)
        {
            var response = result.Value;
            var summary = response.Summary;

            if (!options.IsNonInteractive)
            {
                if (!string.IsNullOrWhiteSpace(response.ReportPath))
                    _ui.WriteKeyValue(&quot;Relatorio&quot;, response.ReportPath);
                if (!string.IsNullOrWhiteSpace(response.UndoLogPath))
                    _ui.WriteKeyValue(&quot;Undo&quot;, response.UndoLogPath);

                if (response.Changes.Count &gt; 0)
                {
                    var show = _input.ReadYesNo(&quot;Mostrar primeiras alteracoes&quot;, false);
                    if (show)
                    {
                        var limit = _input.ReadOptionalInt(&quot;Limite&quot;, &quot;enter para 20&quot;) ?? 20;
                        _ui.Section(&quot;Alteracoes&quot;);
                        foreach (var change in response.Changes.Take(limit))
                            _ui.WriteLine($&quot;{change.Type}: {change.Path}&quot;);
                    }
                }
            }
            else
            {
                // Non-interactive output
                _ui.WriteLine($&quot;FilesScanned={summary.FilesScanned}&quot;);
                _ui.WriteLine($&quot;FilesUpdated={summary.FilesUpdated}&quot;);
                _ui.WriteLine($&quot;Errors={summary.Errors}&quot;);
                if (!string.IsNullOrWhiteSpace(response.ReportPath))
                    _ui.WriteLine($&quot;Report={response.ReportPath}&quot;);
            }
        }

        _ui.PrintRunResult(result);
        return result.IsSuccess &amp;&amp; result.Summary.Failed == 0 ? 0 : 1;
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>