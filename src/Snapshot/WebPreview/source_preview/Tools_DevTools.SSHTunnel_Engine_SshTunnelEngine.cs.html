<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using DevTools.Core.Abstractions;
using DevTools.Core.Models;
using DevTools.Core.Results;
using DevTools.SSHTunnel.Models;
using DevTools.SSHTunnel.Providers;
using DevTools.SSHTunnel.Validation;

namespace DevTools.SSHTunnel.Engine;

public sealed class SshTunnelEngine : IDevToolEngine&lt;SshTunnelRequest, SshTunnelResponse&gt;
{
    private readonly TunnelService _service;

    public SshTunnelEngine(TunnelService? service = null, IProcessRunner? processRunner = null)
    {
        if (service is not null)
        {
            _service = service;
        }
        else
        {
            var runner = processRunner ?? new SystemProcessRunner();
            _service = new TunnelService(runner);
        }
    }

    public async Task&lt;RunResult&lt;SshTunnelResponse&gt;&gt; ExecuteAsync(
        SshTunnelRequest request,
        IProgressReporter? progress = null,
        CancellationToken ct = default)
    {
        var errors = SshTunnelRequestValidator.Validate(request);
        if (errors.Count &gt; 0)
            return RunResult&lt;SshTunnelResponse&gt;.Fail(errors);

        ct.ThrowIfCancellationRequested();

        try
        {
            switch (request.Action)
            {
                case SshTunnelAction.Start:
                    progress?.Report(new ProgressEvent(&quot;Starting SSH tunnel&quot;, 10, &quot;start&quot;));
                    await _service.StartAsync(request.Profile!, null, ct).ConfigureAwait(false);
                    progress?.Report(new ProgressEvent(&quot;SSH tunnel running&quot;, 100, &quot;done&quot;));
                    return RunResult&lt;SshTunnelResponse&gt;.Success(BuildResponse(request.Action));

                case SshTunnelAction.Stop:
                    progress?.Report(new ProgressEvent(&quot;Stopping SSH tunnel&quot;, 50, &quot;stop&quot;));
                    await _service.StopAsync(TimeSpan.FromSeconds(2), ct).ConfigureAwait(false);
                    progress?.Report(new ProgressEvent(&quot;SSH tunnel stopped&quot;, 100, &quot;done&quot;));
                    return RunResult&lt;SshTunnelResponse&gt;.Success(BuildResponse(request.Action));

                case SshTunnelAction.Status:
                    return RunResult&lt;SshTunnelResponse&gt;.Success(BuildResponse(request.Action));

                default:
                    return RunResult&lt;SshTunnelResponse&gt;.Fail(
                        new ErrorDetail(&quot;sshtunnel.action.invalid&quot;, &quot;Action is invalid.&quot;));
            }
        }
        catch (SshTunnelConfigException ex)
        {
            return RunResult&lt;SshTunnelResponse&gt;.Fail(new ErrorDetail(ex.Code, ex.Message, Details: ex.Details, Exception: ex));
        }
        catch (SshTunnelConnectionException ex)
        {
            return RunResult&lt;SshTunnelResponse&gt;.Fail(new ErrorDetail(ex.Code, ex.Message, Details: ex.Details, Exception: ex));
        }
    }

    private SshTunnelResponse BuildResponse(SshTunnelAction action)
    {
        return new SshTunnelResponse(
            action,
            _service.State,
            _service.IsOn,
            _service.CurrentProfile,
            _service.ProcessId,
            _service.LastError);
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>