<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Collections.Generic;
using DevTools.Organizer.Engine;
using DevTools.Organizer.Models;
using DevTools.Presentation.Wpf.Services;
using DevTools.Core.Models;

namespace DevTools.Presentation.Wpf.Views;

public partial class OrganizerWindow : Window
{
    private readonly JobManager _jobManager;
    private readonly SettingsService _settingsService;

    public OrganizerWindow(JobManager jobManager, SettingsService settingsService)
    {
        InitializeComponent();
        _jobManager = jobManager;
        _settingsService = settingsService;

        ProfileSelector.GetOptionsFunc = GetCurrentOptions;
        ProfileSelector.ProfileLoaded += LoadProfile;
        
        // Carregar configura&#231;&#245;es
        if (!string.IsNullOrEmpty(_settingsService.Settings.LastOrganizerInputPath))
            InputPathSelector.SelectedPath = _settingsService.Settings.LastOrganizerInputPath;
        else
            InputPathSelector.SelectedPath = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);

        // Posicionar no canto inferior direito
        Loaded += (s, e) =&gt; 
        {
            var desktopWorkingArea = SystemParameters.WorkArea;
            this.Left = desktopWorkingArea.Right - this.ActualWidth - 20;
            this.Top = desktopWorkingArea.Bottom - this.ActualHeight - 20;
            this.Activate();
        };

        // Comportamento estilo Tray: Fechar ao clicar fora
        this.Deactivated += (s, e) =&gt; 
        {
             // this.Close(); 
             // Comentado para evitar fechamento acidental ao usar dialogs
        };
    }

    private Dictionary&lt;string, string&gt; GetCurrentOptions()
    {
        var options = new Dictionary&lt;string, string&gt;();
        options[&quot;inbox&quot;] = InputPathSelector.SelectedPath;
        options[&quot;output&quot;] = OutputPathSelector.SelectedPath;
        options[&quot;apply&quot;] = (!(SimulateCheck.IsChecked ?? false)).ToString().ToLowerInvariant();
        return options;
    }

    private void LoadProfile(ToolProfile profile)
    {
        if (profile.Options.TryGetValue(&quot;inbox&quot;, out var inbox)) InputPathSelector.SelectedPath = inbox;
        else if (profile.Options.TryGetValue(&quot;input&quot;, out var input)) InputPathSelector.SelectedPath = input;
        
        if (profile.Options.TryGetValue(&quot;output&quot;, out var output)) OutputPathSelector.SelectedPath = output;
        
        if (profile.Options.TryGetValue(&quot;apply&quot;, out var applyStr))
             SimulateCheck.IsChecked = !(bool.TryParse(applyStr, out var a) ? a : false);
    }

    private void Header_MouseLeftButtonDown(object sender, System.Windows.Input.MouseButtonEventArgs e)
    {
        // Dragging disabled per user request
    }

    private void CloseButton_Click(object sender, RoutedEventArgs e)
    {
        Close();
    }

    private void RunButton_Click(object sender, RoutedEventArgs e)
    {
        var inputPath = InputPathSelector.SelectedPath;
        var outputPath = OutputPathSelector.SelectedPath;
        var simulate = SimulateCheck.IsChecked ?? false;

        if (string.IsNullOrWhiteSpace(inputPath))
        {
            MessageBox.Show(&quot;Por favor, selecione uma pasta de entrada.&quot;, &quot;Erro&quot;, MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        // Salvar configura&#231;&#245;es
        _settingsService.Settings.LastOrganizerInputPath = inputPath;
        _settingsService.Save();

        // Se output vazio, usa input (comportamento padr&#227;o do Organizer)
        if (string.IsNullOrWhiteSpace(outputPath))
        {
            outputPath = inputPath;
        }

        // Fecha janela para iniciar background job
        Close();

        // Inicia Job
        _jobManager.StartJob(&quot;Organizer&quot;, async (reporter, ct) =&gt;
        {
            var engine = new OrganizerEngine();
            // Apply = !simulate
            var request = new OrganizerRequest(inputPath, outputPath, null, null, !simulate);
            
            var result = await engine.ExecuteAsync(request, reporter, ct);
            return result.IsSuccess 
                ? $&quot;Organiza&#231;&#227;o conclu&#237;da! Arquivos processados: {result.Value?.Stats.TotalFiles ?? 0}&quot; 
                : $&quot;Falha na organiza&#231;&#227;o: {string.Join(&quot;, &quot;, result.Errors.Select(e =&gt; e.Message))}&quot;;
        });
    }
}</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>