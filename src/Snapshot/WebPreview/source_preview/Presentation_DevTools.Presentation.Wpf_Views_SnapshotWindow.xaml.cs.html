<html><head><meta charset='UTF-8'>
<link rel='stylesheet' href='../prism-tomorrow.min.css'>
<style>
body { background: #1d1d1d; margin: 0; padding: 10px; font-size: 14px; }
pre { border-radius: 6px; }
</style>
</head><body>
<pre><code class='language-csharp'>using System;
using System.Linq;
using System.Windows;
using System.Windows.Input;
using System.Collections.Generic;
using DevTools.Presentation.Wpf.Services;
using DevTools.Snapshot.Engine;
using DevTools.Snapshot.Models;
using DevTools.Core.Models;
using Microsoft.Win32;

namespace DevTools.Presentation.Wpf.Views;

public partial class SnapshotWindow : Window
{
    private readonly JobManager _jobManager;
    private readonly SettingsService _settingsService;

    public SnapshotWindow(JobManager jobManager, SettingsService settingsService)
    {
        InitializeComponent();
        _jobManager = jobManager;
        _settingsService = settingsService;

        ProfileSelector.GetOptionsFunc = GetCurrentOptions;
        ProfileSelector.ProfileLoaded += LoadProfile;

        if (!string.IsNullOrEmpty(_settingsService.Settings.LastSnapshotRootPath))
            RootPathBox.Text = _settingsService.Settings.LastSnapshotRootPath;

        /* Position handled by TrayService
        if (_settingsService.Settings.SnapshotWindowTop.HasValue)
        {
            Top = _settingsService.Settings.SnapshotWindowTop.Value;
            Left = _settingsService.Settings.SnapshotWindowLeft.Value;
        }
        else
        {
            var screen = SystemParameters.WorkArea;
            Left = screen.Right - Width - 20;
            Top = screen.Bottom - Height - 20;
        }

        var workArea = SystemParameters.WorkArea;
        if (Top &lt; 0 || Top &gt; workArea.Height) Top = workArea.Height - Height - 20;
        if (Left &lt; 0 || Left &gt; workArea.Width) Left = workArea.Width - Width - 20;
        */

        /*
        Closed += (s, e) =&gt;
        {
            _settingsService.Settings.SnapshotWindowTop = Top;
            _settingsService.Settings.SnapshotWindowLeft = Left;
            _settingsService.Save();
        };
        */
    }

    private Dictionary&lt;string, string&gt; GetCurrentOptions()
    {
        var options = new Dictionary&lt;string, string&gt;();
        options[&quot;root&quot;] = RootPathBox.Text;
        options[&quot;text&quot;] = (TextCheck.IsChecked ?? true).ToString().ToLowerInvariant();
        options[&quot;html&quot;] = (HtmlCheck.IsChecked ?? false).ToString().ToLowerInvariant();
        options[&quot;json-nested&quot;] = (JsonNestedCheck.IsChecked ?? false).ToString().ToLowerInvariant();
        options[&quot;json-recursive&quot;] = (JsonRecursiveCheck.IsChecked ?? false).ToString().ToLowerInvariant();
        return options;
    }

    private void LoadProfile(ToolProfile profile)
    {
        if (profile.Options.TryGetValue(&quot;root&quot;, out var root)) RootPathBox.Text = root;
        
        if (profile.Options.TryGetValue(&quot;text&quot;, out var text)) 
            TextCheck.IsChecked = bool.TryParse(text, out var t) ? t : true;
            
        if (profile.Options.TryGetValue(&quot;html&quot;, out var html)) 
            HtmlCheck.IsChecked = bool.TryParse(html, out var h) ? h : false;
            
        if (profile.Options.TryGetValue(&quot;json-nested&quot;, out var jn)) 
            JsonNestedCheck.IsChecked = bool.TryParse(jn, out var n) ? n : false;
            
        if (profile.Options.TryGetValue(&quot;json-recursive&quot;, out var jr)) 
            JsonRecursiveCheck.IsChecked = bool.TryParse(jr, out var r) ? r : false;
    }

    private void Header_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        // if (e.ButtonState == MouseButtonState.Pressed) DragMove();
    }

    private void CloseButton_Click(object sender, RoutedEventArgs e) =&gt; Close();

    private void BrowseRoot_Click(object sender, RoutedEventArgs e)
    {
        var dlg = new OpenFolderDialog { Title = &quot;Selecione a Pasta do Projeto&quot; };
        if (dlg.ShowDialog() == true)
        {
            RootPathBox.Text = dlg.FolderName;
            _settingsService.Settings.LastSnapshotRootPath = dlg.FolderName;
            _settingsService.Save();
        }
    }

    private void ProcessButton_Click(object sender, RoutedEventArgs e)
    {
        var root = RootPathBox.Text;
        if (string.IsNullOrWhiteSpace(root))
        {
            MessageBox.Show(&quot;Pasta do Projeto &#233; obrigat&#243;ria.&quot;, &quot;Dados Incompletos&quot;, MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        var genText = TextCheck.IsChecked ?? true;
        var genHtml = HtmlCheck.IsChecked ?? false;
        var genJsonNested = JsonNestedCheck.IsChecked ?? false;
        var genJsonRecursive = JsonRecursiveCheck.IsChecked ?? false;

        Close();

        _jobManager.StartJob(&quot;Snapshot&quot;, async (reporter, ct) =&gt;
        {
            var engine = new SnapshotEngine();
            var request = new SnapshotRequest(
                RootPath: root,
                GenerateText: genText,
                GenerateHtmlPreview: genHtml,
                GenerateJsonNested: genJsonNested,
                GenerateJsonRecursive: genJsonRecursive
            );

            var result = await engine.ExecuteAsync(request, reporter, ct);

            return result.IsSuccess
                ? $&quot;Snapshot gerado com sucesso na pasta &#39;Snapshot&#39;!&quot;
                : $&quot;Falha ao gerar Snapshot: {string.Join(&quot;, &quot;, result.Errors.Select(x =&gt; x.Message))}&quot;;
        });
    }
}
</code></pre>
<script src='../prism.min.js'></script>
<script src='../prism-csharp.min.js'></script>
<script src='../prism-json.min.js'></script>
<script src='../prism-markdown.min.js'></script>
<script src='../prism-markup.min.js'></script>
<script src='../prism-powershell.min.js'></script>
<script src='../prism-yaml.min.js'></script>

</body></html>